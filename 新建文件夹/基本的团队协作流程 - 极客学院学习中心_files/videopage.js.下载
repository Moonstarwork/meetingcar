var videoPage = videoPage || {};

videoPage = {
    init: function() {
        this.bind();
        this.navWidth();
        this.popAction();
        this.cleartext();
        this.starHover();
    },
    lock: true,
    bind: function() {
        $("#CodeDl").on("click", this.popCodeDl); //下载源码按钮提醒

        var $leftnav = $("#leftnav");
        $leftnav.on("click", ".nav-button-show", this.navLeftHide);
        $leftnav.on("click", ".nav-button-hide", this.navLeftShow);
        $(".overbox").on("click", "h3", this.lesson);
        $(".checkans").on("click", this.checkAns);

        $(window).load(this.leftNavHeight);
        $(window).load(this.scrollbar);
        $(window).load(this.scrolltip);
        $(window).load(this.mouseScroll);

        $('.evaluate-cont a').on('click', this.evalSub);
        $('.evaluate-cont li').not('.readonly').on('click', videoPage.addStar);
    },
    mouseScroll: function() {
        var wh = $(window).height(),
            dh = $(document).height();

        var result = dh > wh ? true : false;

        if (result) {
            var monitor = setInterval(function() {
                var top = parseInt($('#mCSB_2_container').css('top'));
                var st = $(document).scrollTop();
                if (top < -20 || st > 20) {
                    $('#scrollTips').fadeOut();
                    clearInterval(monitor);
                }
            }, 500)
        } else {
            return
        }

    },
    popCodeDl: function() {
        layer.msg('课的进度达到80%才可下载哦~', { icon: 5 });
    },
    popAction: function() {
        videoPage.navpop('.overbox', '.h3pop');
        videoPage.navpop('.lesson-content', 'dt');
        videoPage.navpop('.lesson-content', 'dd');
    },
    leftNavHeight: function() {
        var Wh = $(window).height();
        $('.overbox>h3:gt(0)').addClass("up");

        $('#overMain').css({
            height:Wh
        })

        var mainH = $('.main-cont').height();
        $('#leftnav').height(mainH);
        $('#overScroll').height(mainH - 50);
    },
    lesson: function() {
        if ($(this).hasClass("up")) {
            $(this).next(".lesson-content").slideDown();
            $(this).removeClass("up");
            $(this).find("i").css("transform", "rotate(45deg)");
        } else {
            $(this).next(".lesson-content").slideUp();
            $(this).addClass("up");
            $(this).find("i").css("transform", "rotate(225deg)");
        }
    },
    navLeftHide: function() {
        $('#nav-button').animate({
            'margin-left': '0px'
        }, 500, function() {
            $('#nav-button>i').css('transform', 'rotate(180deg)');
            $('#nav-button').removeClass('nav-button-show').addClass('nav-button-hide');
        });
        $('#leftnav').animate({
            width: '0px',
        }, 500);

        $('.main-cont').animate({
            marginLeft: '0px',
            width: '1280px'
        }, 500);
    },
    navLeftShow: function() {
        $('h2').show();
        $('#nav-button').animate({
            'margin-left': '210px'
        }, 500, function() {
            $('#nav-button>i').css('transform', 'rotate(0deg)');
            $('#nav-button').removeClass('nav-button-hide').addClass('nav-button-show');
        });
        $('#leftnav').animate({
            width: '210px'
        }, 500);
        $('.main-cont').animate({
            marginLeft: '210px',
            width: '1070px'
        }, 500);
    },
    // 新弹窗
    popup: function(id, content) {

        $(id).on('click', function() {
            $('#shade').show();
            $(content).fadeIn();

            var contentH = $(content).height();
            var contentW = $(content).width();
            var winH = $(window).height();
            var scrollT = $(window).scrollTop();
            var mart = -contentH / 2;
            var marl = -contentW / 2;

            if ($('.exper').length > 0) {
                var topH = 49;
            } else {
                var topH = 20;
            }
            var mid = scrollT + (winH - contentH) / 2 - topH; //相对定位的居中

            if (mid < 0) {
                var mid = 0;
            }

            if (contentH < winH) {
                $(content).css({
                    'display': 'block',
                    'position': 'fixed',
                    'top': '50%',
                    'left': '50%',
                    'margin-top': mart,
                    'margin-left': marl,
                    'z-index': '901'
                })
            } else {
                $(content).css({
                    'display': 'block',
                    'position': 'absolute',
                    'top': mid,
                    'left': '50%',
                    'margin-left': marl,
                    'z-index': '901'
                })
            }
        });

        $('.popClose').on('click', function() {
            $('#shade').hide();
            $(content).fadeOut();
            var videos = $('.popClose').parent().siblings().find('video');
            if (videos.length < 1) {
                return false
            };
            for (var i = 0; i < videos.length; i++) {
                videos[i].pause(); //暂停视频播放
            }
        });

        $(content).find('.evaluate-cont a')

    },
    // 侧导航泡泡激活和关闭
    navpop: function(dad, son) {
        $(dad).find(son).mouseenter(function() {
            var txt = $(this).html();
            layer.tips(txt, $(this), {
                tips: [2, '#fff'],
                time: 99000
            })
        });
        $(dad).find(son).mouseleave(function() {
            layer.closeAll('tips');
        });
    },
    // 模拟 placeholder 效果
    cleartext: function() {
        var $textarea = $('textarea');
        $textarea.focus(function() {
            $(this).find('p').css('display', 'none');
            $(this).css('opacity', '1');
        });
        $textarea.blur(function() {
            if ($(this).val() == "") {
                $(this).find('p').css('display', 'block');
                $(this).css('opacity', '0');
            }
        });
    },
    // 查看答案
    checkAns: function() {
        $('.checkans').css({
            'background': '#bbb',
            'cursor': 'default'
        });
        $('.ans-cont-titl').css('display', 'block');

        var winH = $(window).height();
        $('#overMain').height(winH);
        var contH = $('.class-test-cont').height();
        $('.class-cont').height(contH + 20);
        var mainH = $('.main-cont').height();
        $('#leftnav').height(mainH);
        $('#overScroll').height(mainH - 50);
    },
    // 修改导航栏次级标题的宽度来调整省略号出现的位置
    navWidth: function() {
        $('.h3pop').has('span').css('padding', '0 70px 0 15px');
    },
    // 滚动条
    scrollbar: function() {
        $('.overbox').mCustomScrollbar({
            scrollInertia: 0,
            mouseWheelPixels: 40
        });
        $('#overMain').mCustomScrollbar({
            scrollInertia: 0,
            mouseWheelPixels: 60
        });
        $('.inner').mCustomScrollbar({
            scrollInertia: 0,
            mouseWheelPixels: 40
        })

    },
    // 滚动提示
    scrolltip: function() {
        var wh = $(window).height(),
            dh = $(document).height(),
            ele = $('#scrollTips');
        var result = dh > wh ? true : false;
        if (result) {
            ele.show();
        } else {
            ele.hide();
        }
    },
    starHover: function() {
        var li = $('.evaluate-cont ul li').not('.readonly');
        li.hover(function() {
            $(this).addClass('actived');
            $(this).prevAll().addClass('actived');
        }, function() {
            $(this).removeClass('actived');
            $(this).prevAll().removeClass('actived');
        });
    },
    addStar: function() {

        var that = $(this);
        var submit = $(this).parent().siblings('a');
        var num = $(this).attr('data-position');
        var text = $(this).parent().siblings('span');

        $(this).nextAll().removeClass('actived');
        $(this).addClass('actived');
        $(this).prevAll().addClass('actived');
        $(this).parents().find('li').off('mouseenter');
        $(this).parents().find('li').off('mouseleave');

        if (num == 1) {
            text.text('非常不满意，差评');
        } else if (num == 2) {
            text.text('不满意，比较差');
        } else if (num == 3) {
            text.text('一般，需要改进');
        } else if (num == 4) {
            text.text('比较满意，可改进');
        } else {
            text.text('很满意');
        }

        videoPage.getEvalute(num, that);
    },
    getEvalute: function(num, that) {

        // var t = $(window).scrollTop();
        // var w = $(window).height();
        var pop = that.parent().parent().parent().parent().parent();
        // var mart = parseInt(pop.css('margin-top'));
        var poph = pop.outerHeight();
        // var m = t + w/2 - poph/2;
        // 以上计算生成dom前弹窗的数值

        var html = '';
        for (var i in evaluateReasons) {
            if (i == num) {
                for (var k in evaluateReasons[i]) {
                    html += '<label><input type="checkbox" class="student_evaluate_chioce" value="' + k + '"><span></span><span>' + evaluateReasons[i][k] + '</span></label>';
                }
            }
        }
        var evaluate = that.parent().siblings('.evaluateContainer');
        evaluate.html(html);
        that.parent().siblings('.textarea-cont').show();
        that.parent().siblings('a').css('display', 'block');

        pop.height(poph);
        // 以下计算生成dom后弹窗的数值
        // var nm = t + w/2 - npoph/2;
        // var move = m - nm; //第二次计算结果应当为0
        // var nmart = mart - move; //第二次及之后的计算结果与第一次相同
        // pop.animate({
        //     'margin-top':nmart
        // });

    },
    evalSub: function() {
        var that = $(this);
        var id = $(this).siblings('.evaluate_homework_id').val();
        var star = $(this).siblings('ul').find('.actived').length;
        var checked = $(this).siblings('.evaluateContainer').find('label').find('input:checked');
        var reasons = [];
        for (var i = 0; i < checked.length; i++) {
            var num = checked[i].value;
            reasons[i] = num;
        }
        var content = $(this).siblings('.textarea-cont').find('textarea').val();

        if (videoPage.lock) {
            if (star < 5 && checked.length < 1) {
                layer.msg('请至少选择一项！', { icon: 2 });
            } else {
                videoPage.lock = false;
                $.ajax({
                    url: window.APP_URL + 'zhiye/course/homework-evaluate',
                    type: 'POST',
                    dataType: 'json',
                    data: {
                        id: id,
                        star: star,
                        reasons: reasons,
                        content: content
                    },
                    success: function(data) {
                        if (data.error === 0) {
                            layer.msg('提交成功!', { icon: 1 });
                            var html = '';
                            for (var i = 0; i < checked.length; i++) {
                                var k = i + 1;
                                var str = k + '.' + $(checked[i]).siblings('span:eq(1)').text() + '<br>';
                                html += str;
                            }
                            if (content.length > 0) {
                                that.parent().find('dl:eq(1) p').append(content);
                            } else {
                                that.parent().find('dl:eq(1) p').hide();
                            }
                            that.parent().find('dl:eq(0) p').append(html);
                            that.hide();
                            that.siblings('.evaluateContainer').hide();
                            that.siblings('.textarea-cont').hide();
                            that.siblings('span').text('感谢你的评价');
                            that.siblings('p').find('span').text('评价老师结果');
                            that.siblings('dl').fadeIn();
                            that.siblings('ul').find('li').off('mouseenter').off('mouseleave').off('click');
                            videoPage.lock = true;
                        } else {
                            layer.msg(data.message, { icon: 5 });
                            videoPage.lock = true;
                        }

                    },
                    error: function() {
                        layer.msg('网络错误，请刷新页面', { icon: 5 });
                        videoPage.lock = true;
                    }
                })
            }
        }

    }
};

$(function() {
    videoPage.init();
});
